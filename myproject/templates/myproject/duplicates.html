{% extends 'myproject/base.html' %}
{% load static %}

{% block content %}
<div class="container py-5">
  <div class="card shadow-lg border-0 rounded-4">
    <div class="card-body">

      <!-- Page Header -->
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-primary mb-0">
          <i class="fas fa-exclamation-triangle me-2 text-primary"></i> Duplicate Beneficiaries
        </h3>
        <a href="{% url 'home' %}" class="btn btn-dark btn-sm">
          <i class="fas fa-arrow-left me-1"></i> Home
        </a>
      </div>

      <!-- Search Input -->
      <div class="alert alert-info d-flex align-items-center mb-4">
        <input type="text" id="searchInput" class="form-control w-50"
               placeholder="Search by ID, Name, IP, Sector, or Phone...">
        <span class="badge bg-info text-light ms-2">
          Total Duplicates: {{ total_duplicates }} | Total Records: {{ total_records }}
        </span>
      </div>

      {% if groups %}
        {% for group in groups %}
          <div class="card mb-2 shadow-sm rounded-3">
            <!-- Entire header clickable -->
            <div class="card-header d-flex justify-content-between align-items-center"
                style="cursor:pointer; padding: 0.75rem 1rem; background-color: #f8f9fa; border-bottom: 1px solid #dee2e6;"
                data-bs-toggle="collapse"
                data-bs-target="#collapse-{{ forloop.counter }}"
                aria-expanded="false"
                aria-controls="collapse-{{ forloop.counter }}">
              
              <div class="d-flex flex-column flex-md-row align-items-md-center gap-2">
                <span class="text-muted fw-semibold" style="min-width: 120px;"><strong>ID:</strong> {{ group.ID_Number|default:"(blank)" }}</span>
                <span class="fst-italic fw-bold">{{ group.records.0.Name|default:"—" }}</span>
                <span class="text-muted ms-2">({{ group.count }} records)</span>
              </div>

              <div>
                <i class="fas fa-chevron-down text-primary"></i>
              </div>
            </div>


            <div id="collapse-{{ forloop.counter }}" class="collapse">
              <div class="card-body p-0">
                <div class="table-responsive">
                  <table class="table table-hover align-middle mb-0">
                    <thead class="bg-light text-primary fw-bold">
                      <tr>
                        <th>#</th>
                        <th>InForm ID</th>
                        <th>Name</th>
                        <th>ID Number</th>
                        <th>Phone</th>
                        <th>IP Name</th>
                        <th>Sector</th>
                        <th>Date</th>
                        <th>Created</th>
                        <th width="125">Actions</th>
                      </tr>
                    </thead>
                    <tbody>
                      {% for r in group.records %}
                        <tr id="row-{{ r.pk }}">
                          <td>{{ forloop.counter }}</td>
                          <td>{{ r.InForm_ID }}</td>
                          <td class="fw-semibold">{{ r.Name|default:"—" }}</td>
                          <td>{{ r.ID_Number }}</td>
                          <td>{{ r.Phone_Number|default:"—" }}</td>
                          <td>{{ r.IP_Name }}</td>
                          <td>{{ r.Sector|default:"—" }}</td>
                          <td>{{ r.Date|default:"—" }}</td>
                          <td>{{ r.Submission_Time|date:"Y-m-d H:i" }}</td>
                          <td>
                            <button type="button" class="btn btn-sm btn-outline-info" title="View details"
                                    onclick="window.location.href='{% url 'beneficiary_details' r.pk %}'">
                              <i class="fas fa-eye"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-danger" title="Delete record"
                                    onclick="confirmDelete({{ r.pk }}, {{ r.InForm_ID|default:'null' }})">
                              <i class="fas fa-trash"></i>
                            </button>
                            <button type="button" class="btn btn-sm btn-outline-secondary" title="View Household"
                                    onclick="window.location.href='{% url 'household_details' r.Household_ID %}'">
                              <i class="fas fa-users"></i>
                            </button>
                          </td>
                        </tr>
                      {% endfor %}
                    </tbody>
                  </table>
                </div>
              </div>
            </div>
          </div>
        {% endfor %}
      {% else %}
        <div class="alert alert-success d-flex align-items-center">
          <i class="fas fa-check-circle me-2"></i>
          No duplicate ID_Number values found.
        </div>
      {% endif %}

    </div>
  </div>
</div>


<!-- Confirm Delete Modal (no fade to avoid animation repaint loops) -->
<div class="modal" id="confirmModal" tabindex="-1" aria-labelledby="confirmModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered">
    <div class="modal-content border-0 shadow-lg">
      <div class="modal-header bg-danger text-white">
        <h5 class="modal-title" id="confirmModalLabel">
          <i class="fas fa-exclamation-triangle me-2"></i> Confirm Deletion
        </h5>
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>

      <form id="deleteForm" method="POST" novalidate>
        {% csrf_token %}
        <input type="hidden" id="delete_pk" name="pk" />
        <div class="modal-body text-dark">
          <p class="fw-semibold mb-3">Are you sure you want to delete this record?</p>

          <div class="form-check mb-2">
            <input hidden class="form-check-input" type="radio" name="delete_option" id="delete_local" value="local" checked>
            <label hidden class="form-check-label" for="delete_local">Delete locally only</label>
          </div>

          <div class="form-check">
            <input hidden class="form-check-input" type="radio" name="delete_option" id="delete_both" value="both">
            <label hidden class="form-check-label" for="delete_both">Delete locally and from source</label>
          </div>
        </div>

        <div class="modal-footer">
          <button type="button" class="btn btn-secondary px-4" data-bs-dismiss="modal">Cancel</button>
          <button type="submit" class="btn btn-danger px-4 fw-bold">Delete</button>
        </div>
      </form>
    </div>
  </div>
</div>


<style>
.card-header:hover {
  background-color: #e9ecef;
  transition: background-color 0.2s;
}

.card-header i.fas {
  transition: transform 0.3s;
}

.card-header .rotate {
  transform: rotate(180deg);
}
</style>

<!-- JS scripts preserved from original -->
<script>
  let currentPk = null;
  function confirmDelete(pk, informId) {
    currentPk = pk;
    document.getElementById('delete_pk').value = pk;

    if (!informId) {
      document.getElementById('delete_both').disabled = true;
      document.getElementById('delete_local').checked = true;
    } else {
      document.getElementById('delete_both').disabled = false;
    }

    var modalEl = document.getElementById('confirmModal');
    var modal = new bootstrap.Modal(modalEl);
    modal.show();
  }

  function hideModal() {
    var modalEl = document.getElementById('confirmModal');
    var modal = bootstrap.Modal.getInstance(modalEl);
    if (modal) modal.hide();
  }

  document.getElementById('deleteForm').addEventListener('submit', function(e) {
    e.preventDefault();
    const pk = currentPk;
    const deleteOption = document.querySelector('input[name="delete_option"]:checked').value;
    const delete_source = (deleteOption === 'both');

    fetch("{% url 'delete_duplicate' 0 %}".replace('/0/', '/' + pk + '/'), {
      method: 'POST',
      headers: { 'X-CSRFToken': '{{ csrf_token }}', 'Content-Type': 'application/x-www-form-urlencoded' },
      body: new URLSearchParams({ 'delete_source': delete_source ? 'true' : 'false' })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        const tr = document.getElementById('row-' + pk);
        if (tr) tr.remove();
        hideModal();
      } else {
        alert("Error: " + (data.error || "Unknown error."));
        hideModal();
      }
    }).catch(err => { console.error(err); alert("Network error."); hideModal(); });
  });

  document.getElementById('searchInput').addEventListener('keyup', function() {
    const query = this.value.toLowerCase().trim();
    const cards = document.querySelectorAll('.card.shadow-sm.rounded-3');

    cards.forEach(card => {
      let found = false;

      const header = card.querySelector('.card-header');
      const headerText = header ? header.innerText.toLowerCase() : '';

      if (headerText.includes(query)) found = true;

      const rows = card.querySelectorAll('tbody tr');
      rows.forEach(row => {
        const cells = [
          row.querySelector('td:nth-child(3)')?.innerText.toLowerCase() || '',
          row.querySelector('td:nth-child(4)')?.innerText.toLowerCase() || '',
          row.querySelector('td:nth-child(5)')?.innerText.toLowerCase() || '',
          row.querySelector('td:nth-child(6)')?.innerText.toLowerCase() || '',
          row.querySelector('td:nth-child(7)')?.innerText.toLowerCase() || ''
        ];
        const match = cells.some(c => c.includes(query));
        row.style.display = match || query === '' ? '' : 'none';
        if (match) found = true;
      });

      // Show/hide card
      card.style.display = found || query === '' ? '' : 'none';

      const collapseDiv = card.querySelector('.collapse');
      if (!collapseDiv) return;
      let bsCollapse = bootstrap.Collapse.getInstance(collapseDiv);
      if (!bsCollapse) bsCollapse = new bootstrap.Collapse(collapseDiv, { toggle: false });

      if (found && query !== '') {
        bsCollapse.show();
      } else if (query === '') {
        bsCollapse.hide();
      } else {
        bsCollapse.hide();
      }

      card.style.border = found && query ? '2px solid #0d6efd' : '';
    });
  });

  // Optional: rotate chevron on collapse
  document.querySelectorAll('.card-header[data-bs-toggle="collapse"]').forEach(header => {
    const icon = header.querySelector('i.fas');
    const collapseDiv = document.querySelector(header.dataset.bsTarget);

    collapseDiv.addEventListener('show.bs.collapse', () => icon.classList.add('rotate'));
    collapseDiv.addEventListener('hide.bs.collapse', () => icon.classList.remove('rotate'));
  });
</script>

<style>
  .rotate {
    transform: rotate(180deg);
    transition: transform 0.3s;
  }
</style>
{% endblock %}