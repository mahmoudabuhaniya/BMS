{% extends 'myproject/base.html' %}

{% block content %}
<div class="container mt-3">

    
    <!-- Last Sync Info -->
    <div id="last-sync-info" class="alert alert-info d-flex justify-content-between align-items-center mb-3">
        <!-- Centered text -->
        <div class="mx-auto text-center">
            <strong>Last Sync Time:</strong> <span id="last-sync-time">{{ last_sync_time }}</span>
        </div>

        <!-- Sync button on the right -->
        <form id="sync-form" 
            action="{% url 'sync_data' %}" 
            method="POST" 
            data-progress-url="{% url 'get_progress' %}" 
            onsubmit="startSync(event)"
            class="ms-auto">
            {% csrf_token %}
            <button id="sync-btn" type="submit" class="btn btn-success">
                <i class="fas fa-sync-alt me-2"></i>
                <span>Sync Data</span>
            </button>
        </form>
    </div>
        <div id="csrf-token" data-csrf-token="{{ csrf_token }}"></div>

    <!-- Sync Progress -->
    <div id="progress-container" style="display: none;">
        <div class="progress-wrapper">
            <div class="progress">
                <div id="progress-bar" class="progress-bar progress-bar-striped progress-bar-animated"></div>
            </div>
            <p id="progress-message" class="status-message mt-2"></p>
        </div>
    </div>    

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 text-primary fw-bold mb-0">DASHBOARD</h1>
        <span class="badge bg-info ms-3 rounded-pill px-3 py-2">Last Sync Time: {{ last_sync_time }}</span>
    </div>

    <div class="row g-4 justify-content-center">
        <!-- View Database -->
        <div class="col-sm-6 col-lg-4">
            <div class="card shadow h-100">
                <div class="card-body d-flex flex-column justify-content-between">
                    <h6 class="text-muted">Beneficiaries</h6>
                    <h2 class="fw-bold text-dark">View Data</h2>
                    <a href="{% url 'inform_data' %}" class="btn btn-outline-dark mt-3">View Database</a>
                </div>
            </div>
        </div>

        <!-- Find Duplicates -->
        <div class="col-sm-6 col-lg-4">
            <div class="card shadow h-100">
                <div class="card-body d-flex flex-column justify-content-between">
                    <h6 class="text-muted">Find Duplicates</h6>
                    <h2 class="fw-bold text-dark">Deduplication</h2>
                    <a href="{% url 'find_duplicates' %}" class="btn btn-outline-dark mt-3">Find Duplicates</a>
                </div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div class="col-sm-6 col-lg-4">
            <div class="card shadow h-100">
                <div class="card-body d-flex flex-column justify-content-between">
                    <h6 class="text-muted">Admin Panel</h6>
                    <h2 class="fw-bold text-dark">Admin</h2>
                    <a href="/admin" class="btn btn-outline-dark mt-3">Admin Panel</a>
                </div>
            </div>
        </div>

        <!-- Manage Form IDs -->
        <div class="col-sm-6 col-lg-4">
            <div class="card shadow h-100">
                <div class="card-body d-flex flex-column justify-content-between">
                    <h6 class="text-muted">Manage Form IDs</h6>
                    <h2 class="fw-bold text-dark">InForm</h2>
                    <a href="{% url 'manage_tokens' %}" class="btn btn-outline-dark mt-3">Form IDs</a>
                </div>
            </div>
        </div>

            <!-- Sync Data -->
        <div class="col-sm-6 col-lg-4">
            <div class="card shadow h-100">
                <div class="card-body d-flex flex-column justify-content-between">
                    <h6 class="text-muted">Load New Records</h6>
                    <h2 class="fw-bold text-success">Sync</h2>
                    <!-- <button id="sync-btn" class="btn btn-outline-success mt-3">Sync Data</button><!-- Disable button if no tokens or not admin -->

                    <form id="sync-form" 
                            action="{% url 'sync_data' %}" 
                            method="POST" 
                            data-progress-url="{% url 'get_progress' %}" 
                            onsubmit="startSync(event)">
                        {% csrf_token %}
                        <button id="sync-btn" type="submit" class="btn btn-outline-success d-flex align-items-right">
                            <i class="fas fa-sync-alt me-2"></i>
                            <span>Sync Data</span>
                        </button>
                    </form>

                </div>
            </div>
        </div>

    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    function startSync(event) {
        event.preventDefault();

        const form = document.getElementById('sync-form');
        const progressUrl = form.dataset.progressUrl;
        const csrfToken = document.getElementById('csrf-token').dataset.csrfToken;

        document.getElementById('progress-container').style.display = 'block';
        const progressBar = document.getElementById('progress-bar');
        const progressMessage = document.getElementById('progress-message');

        // Reset UI before new sync
        progressBar.style.width = '0%';
        progressBar.className = 'progress-bar progress-bar-striped progress-bar-animated bg-primary';
        progressMessage.textContent = "Starting sync...";

        let syncCompleted = false;

        // Start the sync process (non-blocking, backend should trigger async job)
        fetch(form.action, {
            method: 'POST',
            headers: { 'X-CSRFToken': csrfToken },
        })
        .then(response => {
            if (!response.ok) throw new Error('Sync request failed.');
            // Don’t wait for JSON here — backend should just trigger sync and return 202/200
        })
        .catch(error => {
            syncCompleted = true;
            progressBar.className = 'progress-bar bg-danger';
            progressBar.style.width = '100%';
            progressMessage.textContent = "❌ Error: " + error.message;
            setTimeout(() => location.reload(), 8000);
        });

        // Poll progress from backend
        const interval = setInterval(() => {
            if (syncCompleted) {
                clearInterval(interval);
                return;
            }
            fetch(progressUrl)
                .then(response => response.json())
                .then(data => {
                    const { progress, stage, new_count, duplicate_count, invalid_date_count, total_fetched, completed } = data;

                    progressBar.style.width = progress + '%';
                    progressMessage.textContent = stage;

                    if (completed) {
                        syncCompleted = true;
                        progressBar.className = 'progress-bar bg-success';
                        progressBar.style.width = '100%';
                        progressMessage.innerHTML = `✅ Sync completed:<br>
                            ${new_count} new added, 
                            ${duplicate_count} skipped, <br>
                            total fetched: ${total_fetched}.`;

                        setTimeout(() => location.reload(), 9000);
                    }
                })
                .catch(() => {
                    clearInterval(interval);
                    progressMessage.textContent = `Unable to fetch progress.`;
                });
        }, 2000); // poll more frequently for smoother bar
    }
</script>

{% endblock %}

