{% extends 'myproject/base.html' %}
{% block content %}

<div class="container py-5">

  <h3 class="fw-bold text-primary mb-4">
    <i class="fas fa-chart-bar me-2"></i> Supply Usage Dashboard
  </h3>

  <!-- ================= FILTERS ================= -->
  <form method="get" class="card shadow-sm border-0 rounded-4 mb-4">
    <div class="card-body">
      <div class="row g-3 align-items-end">

        <div class="col-md-4">
          <label class="form-label fw-semibold text-primary">
            <i class="fas fa-building me-1"></i> IP
          </label>
          <select name="ip" class="form-select">
            <option value="">All IPs</option>
            {% for ip in ip_list %}
              <option value="{{ ip }}" {% if selected_ip == ip %}selected{% endif %}>{{ ip }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-4">
          <label class="form-label fw-semibold text-primary">
            <i class="fas fa-layer-group me-1"></i> Section
          </label>
          <select name="section" class="form-select">
            <option value="">All Sections</option>
            {% for s in section_list %}
              <option value="{{ s }}" {% if selected_section == s %}selected{% endif %}>{{ s }}</option>
            {% endfor %}
          </select>
        </div>

        <div class="col-md-4 d-flex gap-2">
          <button type="submit" class="btn btn-primary px-4">
            <i class="fas fa-filter me-1"></i> Apply
          </button>
          <a href="{% url 'supply_dashboard' %}" class="btn btn-outline-secondary px-4">
            Reset
          </a>
          <a href="{% url 'export_supply_dashboard_excel' %}?ip={{ selected_ip }}&section={{ selected_section }}"
            class="btn btn-success px-4">
            <i class="fas fa-file-excel me-1"></i> Export Summary
          </a>
        </div>

      </div>
    </div>
  </form>

  <!-- ================= KPI CARDS ================= -->
  <div class="row g-4 mb-4">

    <div class="col-md-3">
      <div class="card shadow-sm border-0 rounded-4 text-center">
        <div class="card-body">
          <i class="fas fa-boxes fa-2x text-primary mb-2"></i>
          <h6>Total Supplies</h6>
          <h3 class="fw-bold">{{ total_supplies }}</h3>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm border-0 rounded-4 text-center">
        <div class="card-body">
          <i class="fas fa-hand-holding-heart fa-2x text-info mb-2"></i>
          <h6>Total Benefits</h6>
          <h3 class="fw-bold">{{ total_benefits }}</h3>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm border-0 rounded-4 text-center">
        <div class="card-body">
          <i class="fas fa-check-circle fa-2x text-success mb-2"></i>
          <h6>Eligible</h6>
          <h3 class="fw-bold text-success">{{ eligible_count }}</h3>
        </div>
      </div>
    </div>

    <div class="col-md-3">
      <div class="card shadow-sm border-0 rounded-4 text-center">
        <div class="card-body">
          <i class="fas fa-ban fa-2x text-danger mb-2"></i>
          <h6>Not Eligible</h6>
          <h3 class="fw-bold text-danger">{{ not_eligible_count }}</h3>
        </div>
      </div>
    </div>

  </div>

  <!-- ================= CHARTS ================= -->
  <div class="row g-4 mb-4">

    <div class="col-md-6">
      <div class="card shadow-sm border-0 rounded-4">
        <div class="card-body">
          <h6 class="fw-bold text-primary">Supply Usage</h6>
          <canvas id="totalChart"></canvas>
        </div>
      </div>
    </div>

    <div class="col-md-6">
      <div class="card shadow-sm border-0 rounded-4">
        <div class="card-body">
          <h6 class="fw-bold text-primary">Eligibility Breakdown</h6>
          <canvas id="eligibilityChart"></canvas>
        </div>
      </div>
    </div>

  </div>

  <!-- ================= TABLE ================= -->
  <div class="card shadow-lg border-0 rounded-4">
    <div class="card-body">
      <div class="table-responsive">
        <table class="table table-hover align-middle">
          <thead class="bg-light text-primary">
            <tr>
              <th>Supply Type</th>
              <th>Eligibility Period</th>
              <th>Total</th>
              <th>Eligible</th>
              <th>Not Eligible</th>
              <th>Last Benefit Date</th>
            </tr>
          </thead>
          <tbody>
            {% for row in usage_data %}
            <tr>
              <td class="fw-semibold">
                <a href="{% url 'supply_beneficiaries' row.supply_type %}?ip={{ selected_ip }}&section={{ selected_section }}"
                   class="text-decoration-none text-primary">
                  {{ row.supply_type }}
                </a>
              </td>
              <td>{{ row.eligibility_period }} Days</td>
              <td>{{ row.total }}</td>
              <td><span class="badge bg-success">{{ row.eligible }}</span></td>
              <td><span class="badge bg-danger">{{ row.not_eligible }}</span></td>
              <td>{{ row.last_date|default:"â€”" }}</td>
            </tr>
            {% empty %}
            <tr><td colspan="6" class="text-center">No data</td></tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

</div>

<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script>
const labels = {{ chart_labels|safe }};
const totalData = {{ chart_total|safe }};
const eligibleData = {{ chart_eligible|safe }};
const notEligibleData = {{ chart_not_eligible|safe }};

new Chart(document.getElementById('totalChart'), {
  type: 'bar',
  data: {
    labels: labels,
    datasets: [{ label: 'Total', data: totalData, backgroundColor: '#009FE3' }]
  }
});

new Chart(document.getElementById('eligibilityChart'), {
  type: 'bar',
  data: {
    labels: labels,
    datasets: [
      { label: 'Eligible', data: eligibleData, backgroundColor: '#28a745' },
      { label: 'Not Eligible', data: notEligibleData, backgroundColor: '#dc3545' }
    ]
  },
  options: { scales: { x: { stacked: true }, y: { stacked: true } } }
});
</script>

{% endblock %}
