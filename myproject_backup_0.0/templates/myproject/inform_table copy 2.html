<!-- Total Records Info -->
<div class="mb-2 text-end">
    <span class="badge bg-info ms-3 rounded-pill px-3 py-2 fw-bold">
        Filtered: {{ total_records }} / Total: {{ total_all_records }} records
    </span>
</div>

<div class="card mb-3">
    <div class="card-body p-0">
        <div class="table-responsive">
            <table class="table table-hover mb-0">
                <thead>
                <tr>
                    <th>
                    <a href="?sort={% if current_sort == 'Submission_Time' %}-Submission_Time{% else %}Submission_Time{% endif %}">
                        Submission Time
                        {% if current_sort == 'Submission_Time' %}
                        <i class="fa fa-sort-asc"></i>
                        {% elif current_sort == '-Submission_Time' %}
                        <i class="fa fa-sort-desc"></i>
                        {% endif %}
                    </a>
                    </th>
                    <th>
                    <a href="?sort={% if current_sort == 'IP_Name' %}-IP_Name{% else %}IP_Name{% endif %}">
                        IP Name
                        {% if current_sort == 'IP_Name' %}
                        <i class="fa fa-sort-asc"></i>
                        {% elif current_sort == '-IP_Name' %}
                        <i class="fa fa-sort-desc"></i>
                        {% endif %}
                    </a>
                    </th>
                    <th>
                    <a href="?sort={% if current_sort == 'Sector' %}-Sector{% else %}Sector{% endif %}">
                        Sector
                        {% if current_sort == 'Sector' %}
                        <i class="fa fa-sort-asc"></i>
                        {% elif current_sort == '-Sector' %}
                        <i class="fa fa-sort-desc"></i>
                        {% endif %}
                    </a>
                    </th>
                    <th>
                    <a href="?sort={% if current_sort == 'Indicator' %}-Indicator{% else %}Indicator{% endif %}">
                        Indicator
                        {% if current_sort == 'Indicator' %}
                        <i class="fa fa-sort-asc"></i>
                        {% elif current_sort == '-Indicator' %}
                        <i class="fa fa-sort-desc"></i>
                        {% endif %}
                    </a>
                    </th>
                    <th>
                    <a href="?sort={% if current_sort == 'Date' %}-Date{% else %}Date{% endif %}">
                        Date
                        {% if current_sort == 'Date' %}
                        <i class="fa fa-sort-asc"></i>
                        {% elif current_sort == '-Date' %}
                        <i class="fa fa-sort-desc"></i>
                        {% endif %}
                    </a>
                    </th>
                    <th>
                    <a href="?sort={% if current_sort == 'Name' %}-Name{% else %}Name{% endif %}">
                        Name
                        {% if current_sort == 'Name' %}
                        <i class="fa fa-sort-asc"></i>
                        {% elif current_sort == '-Name' %}
                        <i class="fa fa-sort-desc"></i>
                        {% endif %}
                    </a>
                    </th>
                    <th>
                    <a href="?sort={% if current_sort == 'ID_Number' %}-ID_Number{% else %}ID_Number{% endif %}">
                        ID Number
                        {% if current_sort == 'ID_Number' %}
                        <i class="fa fa-sort-asc"></i>
                        {% elif current_sort == '-ID_Number' %}
                        <i class="fa fa-sort-desc"></i>
                        {% endif %}
                    </a>
                    </th>
                   
                    <th>Actions</th>
                </tr>
                </thead>

                <tbody>
                    {% for submission in submissions %}
                        <tr id="row-{{ submission.pk }}">
                            <td>{{ submission.Submission_Time|default:"N/A" }}</td>
                            <td>{{ submission.IP_Name|default:"N/A" }}</td>
                            <td>{{ submission.Sector|default:"N/A" }}</td>
                            <td>{{ submission.Indicator|default:"N/A" }}</td>
                            <td>{{ submission.Date|default:"N/A" }}</td>
                            <td>{{ submission.Name|default:"N/A" }}</td>
                            <td>{{ submission.ID_Number|default:"N/A" }}</td>
                            
                            
                            <td>
                                <!-- Details button -->
                                <button type="button" 
                                        class="btn btn-sm btn-outline-info" 
                                        title="View details"
                                        onclick="window.location.href='{% url 'beneficiary_details' submission.InForm_ID %}'">
                                    <i class="fa fa-info"></i>
                                </button>

                                <!-- Delete button -->
                                <button type="button" 
                                        class="btn btn-sm btn-outline-danger" 
                                        title="Delete record" 
                                        onclick="confirmDelete({{ submission.pk }}, {{ submission.InForm_ID|default:'null' }})">
                                    <i class="fa fa-trash"></i>
                                </button>

                                <!-- Household button -->
                                <button type="button" 
                                        class="btn btn-sm btn-outline-danger" 
                                        title="View Household" 
                                        onclick="window.location.href='{% url 'household_details' submission.Household_ID %}'">
                                    <i class="fa fa-users"></i>
                                </button>

                            </td>
                        </tr>
                    {% empty %}
                        <tr>
                            <td colspan="11" class="text-center">No records found</td>
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Pagination -->
<nav class="mt-3">
    <ul class="pagination justify-content-center">
        {% if submissions.has_previous %}
            <li class="page-item">
                <a class="page-link" href="?page=1{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"><i class="fas fa-angles-left"></i></i></a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ submissions.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"><i class="fas fa-angle-left"></i></a>
            </li>
        {% else %}
            <li class="page-item disabled"><span class="page-link"><i class="fas fa-angles-left"></i></span></li>
            <li class="page-item disabled"><span class="page-link"><i class="fas fa-angle-left"></i></span></li>
        {% endif %}

        {% for num in submissions.paginator.page_range %}
            {% if submissions.number == num %}
                <li class="page-item active"><span class="page-link">{{ num }}</span></li>
            {% elif num >= submissions.number|add:-2 and num <= submissions.number|add:2 %}
                <li class="page-item"><a class="page-link" href="?page={{ num }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a></li>
            {% endif %}
        {% endfor %}

        {% if submissions.has_next %}
            <li class="page-item">
                <a class="page-link" href="?page={{ submissions.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"><i class="fas fa-angle-right text-primary"></i></a>
            </li>
            <li class="page-item">
                <a class="page-link" href="?page={{ submissions.paginator.num_pages }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}"><i class="fas fa-angles-right text-primary"></i></a>
            </li>
        {% else %}
            <li class="page-item disabled"><span class="page-link"><i class="fas fa-angle-right"></i></span></li>
            <li class="page-item disabled"><span class="page-link"><i class="fas fa-angles-right"></i></span></li>
        {% endif %}
    </ul>
</nav>


<!-- Delete confirmation modal -->
<div class="modal fade" id="confirmModal" tabindex="-1" role="dialog" aria-hidden="true">
  <div class="modal-dialog modal-dialog-centered" role="document">
    <div class="modal-content">
      <form id="deleteForm">
        <div class="modal-header">
          <h5 class="modal-title">Delete Record</h5>
          <button type="button" class="close" data-bs-dismiss="modal" aria-label="Close" onclick="hideModal()">
            <span aria-hidden="true">&times;</span>
          </button>
        </div>
        <div class="modal-body">
          <p id="modal-body-text">Are you sure you want to delete this record?</p>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="delete_option" id="delete_local" value="local" checked>
            <label class="form-check-label" for="delete_local">Delete from local database only</label>
          </div>
          <div class="form-check">
            <input class="form-check-input" type="radio" name="delete_option" id="delete_both" value="both">
            <label class="form-check-label" for="delete_both">Delete from local database and from InForm (if linked)</label>
          </div>
        </div>
        <div class="modal-footer">
          <input type="hidden" id="delete_pk" name="pk" value="">
          <button type="button" class="btn btn-secondary" data-bs-dismiss="modal" onclick="hideModal()">Cancel</button>
          <button type="submit" class="btn btn-danger">Delete</button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Add basic JS for modal and deletion -->
<script>
  let currentPk = null;

  function confirmDelete(pk, informId) {
    currentPk = pk;
    document.getElementById('delete_pk').value = pk;

    // show/hide InForm delete option depending on if informId exists
    if (informId === null || informId === 'null' || informId === '') {
      document.getElementById('delete_both').disabled = true;
      document.getElementById('delete_local').checked = true;
    } else {
      document.getElementById('delete_both').disabled = true; // change this to true to re enable the both delete option
    }

    // show modal (bootstrap 5)
    var modalEl = document.getElementById('confirmModal');
    var modal = new bootstrap.Modal(modalEl);
    modal.show();
  }

  function hideModal(){
    var modalEl = document.getElementById('confirmModal');
    var modal = bootstrap.Modal.getInstance(modalEl);
    if (modal) modal.hide();
  }

  document.getElementById('deleteForm').addEventListener('submit', function(e){
    e.preventDefault();
    const pk = currentPk;
    const deleteOption = document.querySelector('input[name="delete_option"]:checked').value;
    const delete_source = (deleteOption === 'both');

    fetch("{% url 'delete_inform' 0 %}".replace('/0/', '/' + pk + '/'), {
      method: 'POST',
      headers: {
        'X-CSRFToken': '{{ csrf_token }}',
        'Content-Type': 'application/x-www-form-urlencoded'
      },
      body: new URLSearchParams({
        'delete_source': delete_source ? 'true' : 'false'
      })
    })
    .then(r => r.json())
    .then(data => {
      if (data.success) {
        // remove row from DOM
        const tr = document.getElementById('row-' + pk);
        if (tr) tr.remove();
        hideModal();
      } else {
        alert("Error: " + (data.error || "Unknown error."));
        hideModal();
      }
    })
    .catch(err => {
      console.error(err);
      alert("Network error while deleting record.");
      hideModal();
    });
  });

</script>
