
<div class="container py-5">

  <!-- Total Records Info -->
  <div class="d-flex justify-content-between align-items-center mb-3">
    <!-- Left-aligned instruction text with icon -->
    <span class="text-primary fw-bold">
      <i class="fas fa-info-circle me-2"></i> Click on any column header to sort the data
    </span>

    <!-- Right-aligned badge -->
    <span class="badge bg-info text-light rounded-pill px-3 py-2 fw-bold">
      Filtered: {{ total_records }} / Total: {{ total_all_records }} records
    </span>
  </div>



  <div class="card shadow-lg border-0 rounded-4 mb-4">
    <div class="card-body p-0">
      <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
          <thead class="bg-light text-primary fw-bold">
            <tr>
              <th>
                <a href="?sort={% if current_sort == 'Submission_Time' %}-Submission_Time{% else %}Submission_Time{% endif %}" class="text-decoration-none text-primary">
                  <i class="fas fa-calendar-alt me-1"></i> Submission Time
                  {% if current_sort == 'Submission_Time' %}
                    <i class="fa fa-long-arrow-up ms-1 text-danger"></i>
                  {% elif current_sort == '-Submission_Time' %}
                    <i class="fa fa-long-arrow-down ms-1 text-danger"></i>
                  {% endif %}
                </a>
              </th>
              <th>
                <a href="?sort={% if current_sort == 'IP_Name' %}-IP_Name{% else %}IP_Name{% endif %}" class="text-decoration-none text-primary">
                  <i class="fas fa-user-tie me-1"></i> IP Name
                  {% if current_sort == 'IP_Name' %}
                    <i class="fa fa-long-arrow-up ms-1 text-danger"></i>
                  {% elif current_sort == '-IP_Name' %}
                    <i class="fa fa-long-arrow-down ms-1 text-danger"></i>
                  {% endif %}
                </a>
              </th>
              <th>
                <a href="?sort={% if current_sort == 'Sector' %}-Sector{% else %}Sector{% endif %}" class="text-decoration-none text-primary">
                  <i class="fas fa-sitemap me-1"></i> Sector
                  {% if current_sort == 'Sector' %}
                    <i class="fa fa-long-arrow-up ms-1 text-danger"></i>
                  {% elif current_sort == '-Sector' %}
                    <i class="fa fa-long-arrow-down ms-1 text-danger"></i>
                  {% endif %}
                </a>
              </th>
              <th>
                <a href="?sort={% if current_sort == 'Indicator' %}-Indicator{% else %}Indicator{% endif %}" class="text-decoration-none text-primary">
                  <i class="fas fa-bullseye me-1"></i> Indicator
                  {% if current_sort == 'Indicator' %}
                    <i class="fa fa-long-arrow-up ms-1 text-danger"></i>
                  {% elif current_sort == '-Indicator' %}
                    <i class="fa fa-long-arrow-down ms-1 text-danger"></i>
                  {% endif %}
                </a>
              </th>
              <th>
                <a href="?sort={% if current_sort == 'Date' %}-Date{% else %}Date{% endif %}" class="text-decoration-none text-primary">
                  <i class="fas fa-calendar-check me-1"></i> Date
                  {% if current_sort == 'Date' %}
                    <i class="fa fa-long-arrow-up ms-1 text-danger"></i>
                  {% elif current_sort == '-Date' %}
                    <i class="fa fa-long-arrow-down ms-1 text-danger"></i>
                  {% endif %}
                </a>
              </th>
              <th>
                <a href="?sort={% if current_sort == 'Name' %}-Name{% else %}Name{% endif %}" class="text-decoration-none text-primary">
                  <i class="fas fa-user me-1"></i> Name
                  {% if current_sort == 'Name' %}
                    <i class="fa fa-long-arrow-up ms-1 text-danger"></i>
                  {% elif current_sort == '-Name' %}
                    <i class="fa fa-long-arrow-down ms-1 text-danger"></i>
                  {% endif %}
                </a>
              </th>
              <th>
                <a href="?sort={% if current_sort == 'ID_Number' %}-ID_Number{% else %}ID_Number{% endif %}" class="text-decoration-none text-primary">
                  <i class="fas fa-id-card me-1"></i> ID Number
                  {% if current_sort == 'ID_Number' %}
                    <i class="fa fa-long-arrow-up ms-1 text-danger"></i>
                  {% elif current_sort == '-ID_Number' %}
                    <i class="fa fa-long-arrow-down ms-1 text-danger"></i>
                  {% endif %}
                </a>
              </th>
              <th width="125">
                <i class="fas fa-cogs me-1"></i> Actions
              </th>
            </tr>
          </thead>


          <tbody>
            {% for submission in submissions %}
            <tr id="row-{{ submission.pk }}">
              <td>{{ submission.Submission_Time|default:"N/A" }}</td>
              <td>{{ submission.IP_Name|default:"N/A" }}</td>
              <td>{{ submission.Sector|default:"N/A" }}</td>
              <td>{{ submission.Indicator|default:"N/A" }}</td>
              <td>{{ submission.Date|default:"N/A" }}</td>
              <td class="fw-semibold">{{ submission.Name|default:"N/A" }}</td>
              <td>{{ submission.ID_Number|default:"N/A" }}</td>
              <td>
                <button type="button" 
                  class="btn btn-sm btn-outline-info" 
                  title="View details"
                  data-pk="{{ submission.pk }}"
                  data-inform="{{ submission.InForm_ID|default:'null' }}"
                  onclick="window.location.href='{% url 'beneficiary_details' submission.pk %}'">
                  <i class="fas fa-eye"></i>
                </button>
                <button type="button"
                  class="btn btn-sm btn-outline-danger delete-btn"
                  data-bs-toggle="modal"
                  data-pk="{{ submission.pk }}"
                  data-inform="{{ submission.InForm_ID|default:'null' }}"
                  title="Delete record">
                  <i class="fas fa-trash"></i>
                </button>
                <button type="button" 
                  class="btn btn-sm btn-outline-secondary" 
                  title="View Household"
                  onclick="window.location.href='{% url 'household_details' submission.Household_ID %}'">
                  <i class="fas fa-users"></i>
                </button>
              </td>
            </tr>
            {% empty %}
            <tr>
              <td colspan="8" class="text-center">No records found</td>
            </tr>
            {% endfor %}
          </tbody>
        </table>
      </div>
    </div>
  </div>

  <!-- Pagination -->
  <nav class="mt-3">
    <ul class="pagination justify-content-center">
      {% if submissions.has_previous %}
        <li class="page-item">
          <a class="page-link" href="?page=1{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
            <i class="fas fa-angles-left"></i>
          </a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?page={{ submissions.previous_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
            <i class="fas fa-angle-left"></i>
          </a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link"><i class="fas fa-angles-left"></i></span></li>
        <li class="page-item disabled"><span class="page-link"><i class="fas fa-angle-left"></i></span></li>
      {% endif %}

      {% for num in submissions.paginator.page_range %}
        {% if submissions.number == num %}
          <li class="page-item active"><span class="page-link">{{ num }}</span></li>
        {% elif num >= submissions.number|add:-2 and num <= submissions.number|add:2 %}
          <li class="page-item"><a class="page-link" href="?page={{ num }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">{{ num }}</a></li>
        {% endif %}
      {% endfor %}

      {% if submissions.has_next %}
        <li class="page-item">
          <a class="page-link" href="?page={{ submissions.next_page_number }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
            <i class="fas fa-angle-right text-primary"></i>
          </a>
        </li>
        <li class="page-item">
          <a class="page-link" href="?page={{ submissions.paginator.num_pages }}{% for key,value in request.GET.items %}{% if key != 'page' %}&{{ key }}={{ value }}{% endif %}{% endfor %}">
            <i class="fas fa-angles-right text-primary"></i>
          </a>
        </li>
      {% else %}
        <li class="page-item disabled"><span class="page-link"><i class="fas fa-angle-right"></i></span></li>
        <li class="page-item disabled"><span class="page-link"><i class="fas fa-angles-right"></i></span></li>
      {% endif %}
    </ul>
  </nav>

</div>
</div>


<!-- Delete Confirmation Modal -->


{% comment %}
  Script: initializes modal once with focus:false and stable options.
  Paste this script once (preferably in {% block extra_scripts %} or right before </body>).
{% endcomment %}
<script>
document.addEventListener('DOMContentLoaded', () => {
  // Elements
  const modalEl = document.getElementById('confirmModal');
  const deleteForm = document.getElementById('deleteForm');
  const deletePkInput = document.getElementById('delete_pk');
  const deleteLocal = document.getElementById('delete_local');
  const deleteBoth = document.getElementById('delete_both');

  if (!modalEl) {
    console.error('confirmModal not found in DOM.');
    return;
  }

  // Create ONE modal instance with focus disabled (prevents aggressive refocus loops)
  const confirmModal = new bootstrap.Modal(modalEl, {
    backdrop: 'static',   // don't close by clicking outside
    keyboard: false,      // don't close with Esc
    focus: false          // avoid bootstrap's auto-focus which can cause loops
  });

  let currentPk = null;

  // Use delegated binding in case table updates; this also avoids duplicate bindings
  document.addEventListener('click', (e) => {
    const btn = e.target.closest('.delete-btn');
    if (!btn) return;
    e.preventDefault();

    // Read data attributes
    const pk = btn.getAttribute('data-pk');
    const informId = btn.getAttribute('data-inform');

    currentPk = pk;
    deletePkInput.value = pk;

    // Enable/disable both option safely
    if (!informId || informId === 'null' || informId === '') {
      deleteBoth.disabled = true;
      deleteLocal.checked = true;
    } else {
      deleteBoth.disabled = false; // changer thi sto false to enable InForm Deletion
    }

    // Show modal (already initialized). Small timeout to allow layout settle.
    setTimeout(() => {
      confirmModal.show();

      // After showing, explicitly move focus into the modal once (mitigates focus race)
      // We wait slightly because some browsers process focus after show event.
      setTimeout(() => {
        // prefer close button as focus target
        const focusTarget = modalEl.querySelector('.btn-close') || modalEl.querySelector('button, [tabindex]');
        if (focusTarget) focusTarget.focus({ preventScroll: true });
      }, 40);
    }, 30);
  });

  // Form submit â€” single handler
  deleteForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    const pk = deletePkInput.value;
    if (!pk) {
      console.error('No pk set before submit.');
      confirmModal.hide();
      return;
    }

    const deleteSource = document.querySelector('input[name="delete_option"]:checked')?.value === 'both';

    try {
      const response = await fetch("{% url 'delete_inform' 0 %}".replace('/0/', '/' + pk + '/'), {
        method: 'POST',
        headers: {
          'X-CSRFToken': '{{ csrf_token }}',
          'Content-Type': 'application/x-www-form-urlencoded'
        },
        body: new URLSearchParams({ 'delete_source': deleteSource ? 'true' : 'false' })
      });

      const data = await response.json();
      if (data && data.success) {
        // remove row in DOM (if exists)
        const row = document.getElementById('row-' + pk);
        if (row) row.remove();
      } else {
        alert("Error: " + (data && data.error ? data.error : 'Unknown error.'));
      }
    } catch (err) {
      console.error(err);
      alert('Network error while deleting record.');
    } finally {
      confirmModal.hide();
    }
  });

  /* --- Diagnostic quick test (uncomment to test) ---
     If you want to check if the backdrop is the cause, change backdrop:false.
     Uncomment the next lines (temporary) - then click delete to see if flicker stops.
  */
  // confirmModal._config.backdrop = false;
});

document.addEventListener('click', function(e) {
  if (e.target.closest('.delete-btn')) {
    const button = e.target.closest('.delete-btn');
    const recordId = button.dataset.recordId;
    document.getElementById('confirmDeleteBtn').dataset.recordId = recordId;
  }
});

filters.forEach(input => {
  input.addEventListener('input', debounce(() => {
    const params = new URLSearchParams();
    filters.forEach(f => {
      if (f.value) params.append(f.dataset.field, f.value);
    });

    fetch("{% url 'inform_data' %}?" + params.toString(), {
      headers: { 'X-Requested-With': 'XMLHttpRequest' }
    })
    .then(res => res.text())
    .then(html => {
      document.getElementById('table-container').innerHTML = html;
    });
  }, 500)); // add small delay
});

function debounce(fn, delay) {
  let timer;
  return (...args) => {
    clearTimeout(timer);
    timer = setTimeout(() => fn(...args), delay);
  };
}

</script>






