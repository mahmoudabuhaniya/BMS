{% extends 'myproject/base.html' %}
{% load static %}

{% block content %}
<div class="container py-5">
  <div class="card shadow-lg border-0 rounded-4">
    <div class="card-body">
      <div class="d-flex justify-content-between align-items-center mb-4">
        <h3 class="fw-bold text-primary mb-0">
          <i class="fas fa-user-plus me-2 text-primary"></i> Add New Beneficiary
        </h3>
        <a href="javascript:history.back()" class="btn btn-dark btn-sm">
          <i class="fas fa-arrow-left me-1"></i> Back
        </a>
      </div>

      <!-- Duplicate alert placeholder -->
      <div id="duplicate-alert" class="alert alert-warning d-none"></div>

      <form method="post" class="needs-validation" novalidate id="addForm">
        {% csrf_token %}
        <div class="row g-4">
          <!-- IP Name -->
          <div class="col-md-6">
            <label class="form-label fw-semibold">IP Name</label>
            <input type="text" name="IP_Name" class="form-control">
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">Sector</label>
            <input type="text" name="Sector" class="form-control">
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">Indicator</label>
            <input type="text" name="Indicator" class="form-control">
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">Date</label>
            <input type="date" name="Date" class="form-control">
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">Name</label>
            <input type="text" name="Name" class="form-control">
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">ID Number</label>
            <input type="text" name="ID_Number" id="id_number" class="form-control" placeholder="Enter ID number...">
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">Parent ID</label>
            <input type="text" name="Parent_ID" class="form-control">
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">Spouse ID</label>
            <input type="text" name="Spouse_ID" class="form-control">
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">Phone Number</label>
            <input type="text" name="Phone_Number" class="form-control">
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">Date of Birth</label>
            <input type="date" name="Date_of_Birth" class="form-control">
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">Age</label>
            <input type="number" name="Age" class="form-control">
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">Gender</label>
            <select name="Gender" class="form-select">
              <option value="">-- Select --</option>
              <option value="Male">Male</option>
              <option value="Female">Female</option>
            </select>
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">Governorate</label>
            <input type="text" name="Governorate" class="form-control">
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">Municipality</label>
            <input type="text" name="Municipality" class="form-control">
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">Neighborhood</label>
            <input type="text" name="Neighborhood" class="form-control">
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">Site Name</label>
            <input type="text" name="Site_Name" class="form-control">
          </div>

          <div class="col-md-6">
            <label class="form-label fw-semibold">Disability Status</label>
            <input type="text" name="Disability_Status" class="form-control">
          </div>
        </div>

        <div class="text-end mt-4">
          <button type="submit" class="btn btn-success px-4">
            <i class="fas fa-save me-2"></i> Add Beneficiary
          </button>
        </div>
      </form>
    </div>
  </div>
</div>

<!-- Duplicate check AJAX -->
<script>
document.addEventListener('DOMContentLoaded', function() {
  const idInput = document.getElementById('id_number');
  const alertBox = document.getElementById('duplicate-alert');

  idInput.addEventListener('blur', function() {
    const idNumber = this.value.trim();
    if (!idNumber) return;

    fetch(`/check_duplicate/?id_number=${encodeURIComponent(idNumber)}`)
      .then(res => res.json())
      .then(data => {
        if (data.exists) {
          alertBox.innerHTML = `
            <div class="alert alert-warning d-flex flex-column align-items-start p-3 shadow-sm rounded-3">
              <div>
                <i class="fas fa-exclamation-triangle me-2"></i>
                A beneficiary with this ID already exists 
                <strong>(${data.count} record${data.count > 1 ? 's' : ''})</strong>.
              </div>
              <div class="mt-2">
                <button type="button" class="btn btn-sm btn-outline-primary me-2" id="viewExisting">
                  <i class="fas fa-eye me-1"></i> View Existing
                </button>
                <button type="button" class="btn btn-sm btn-warning" id="continueAdd">
                  <i class="fas fa-plus me-1"></i> Continue Adding New
                </button>
              </div>
            </div>
          `;
          alertBox.classList.remove('d-none');

          // When clicking “View Existing”
          document.getElementById('viewExisting').onclick = () => {
            if (data.source === "inform") {
              window.open(`https://data.inform.unicef.org/unicefstateofpalestine/submission/${data.pk}`, '_blank');
            } else {
              window.location.href = `/beneficiary/${data.pk}`;
            }
          };

          // When clicking “Continue Adding New”
          document.getElementById('continueAdd').onclick = () => {
            alertBox.classList.add('d-none');
          };

        } else {
          alertBox.classList.add('d-none');
        }
      })
      .catch(err => {
        console.error('Error checking duplicate:', err);
      });
  });
});
</script>

{% endblock %}
