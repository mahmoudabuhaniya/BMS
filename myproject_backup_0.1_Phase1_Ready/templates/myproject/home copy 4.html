{% extends 'myproject/base.html' %}

{% block content %}
<div class="container mt-3">

    <!-- Sync Message Area -->
    <div id="sync-status" class="text-center mb-4" style="display: none;"></div>

    {% if messages %}
        <div id="message-container">
            {% for message in messages %}
                <div class="alert alert-{{ message.tags }} text-center fade-out">{{ message }}</div>
            {% endfor %}
        </div>
    {% endif %}

    <!-- Last Sync Info -->
    <div id="last-sync-info" class="alert alert-info text-center mb-3">
        <strong>Last Sync:</strong> <span id="last-sync-time">{{ last_sync_time }}</span>
    </div>

    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1 class="h3 text-primary fw-bold mb-0">DASHBOARD</h1>
        <span class="badge bg-success ms-3 rounded-pill px-3 py-2">Beneficiaries Data from InForm</span>
    </div>

    <div class="row g-4 justify-content-center">
        <!-- View Database -->
        <div class="col-sm-6 col-lg-4">
            <div class="card shadow h-100">
                <div class="card-body d-flex flex-column justify-content-between">
                    <h6 class="text-muted">Beneficiaries</h6>
                    <h2 class="fw-bold text-primary">View Data</h2>
                    <a href="{% url 'inform_data' %}" class="btn btn-outline-primary mt-3">View Database</a>
                </div>
            </div>
        </div>

        <!-- Admin Panel -->
        <div class="col-sm-6 col-lg-4">
            <div class="card shadow h-100">
                <div class="card-body">
                    <h6 class="text-muted">Admin Panel</h6>
                    <h2 class="fw-bold text-dark">Admin</h2>
                    <a href="/admin" class="btn btn-outline-dark mt-3">Admin Panel</a>
                </div>
            </div>
        </div>

        <!-- Sync Data -->
        <div class="col-sm-6 col-lg-4">
            <div class="card shadow h-100">
                <div class="card-body">
                    <h6 class="text-muted">Load New Records</h6>
                    <h2 class="fw-bold text-success">Sync</h2>
                    <button id="sync-btn" class="btn btn-outline-success mt-3">Sync Data</button>
                </div>
            </div>
        </div>

        <!-- Manage Form IDs -->
        <div class="col-sm-6 col-lg-4">
            <div class="card shadow h-100">
                <div class="card-body">
                    <h6 class="text-muted">Manage Form IDs</h6>
                    <h2 class="fw-bold text-primary">InForm</h2>
                    <a href="{% url 'manage_tokens' %}" class="btn btn-outline-primary mt-3">Form IDs</a>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_scripts %}
<script>
    document.addEventListener("DOMContentLoaded", function () {
        const syncBtn = document.getElementById("sync-btn");
        const syncStatus = document.getElementById("sync-status");
        const lastSyncTime = document.getElementById("last-sync-time");

        if (syncBtn) {
            syncBtn.addEventListener("click", function () {
                syncBtn.disabled = true;
                syncStatus.style.display = "block";
                syncStatus.innerHTML = `<div class="alert alert-info">⏳ Syncing data, please wait...</div>`;

                fetch("{% url 'sync_inform_data' %}", {
                    method: "POST",
                    headers: {
                        "X-CSRFToken": "{{ csrf_token }}",
                        "X-Requested-With": "XMLHttpRequest"
                    }
                })
                .then(response => response.json())
                .then(data => {
                    const cls = data.status === "success" ? "success" : "danger";
                    syncStatus.innerHTML = `<div class="alert alert-${cls}" role="alert">${data.message}</div>`;
                    if (data.last_sync) {
                        lastSyncTime.textContent = data.last_sync;
                    }
                })
                .catch(() => {
                    syncStatus.innerHTML = `<div class="alert alert-danger">❌ Sync failed: Network error</div>`;
                })
                .finally(() => {
                    setTimeout(() => window.location.reload(), 4000);
                });
            });
        }
    });
</script>
{% endblock %}
